<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gobblet</title>
</head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
<body>
  <h1 align="center">Gobblet</h1>
  <p id = 'text' align="center"></p>


<table align="center">
  <tr>
    <td id = 'p1StackCell' ></td>
    <td bgcolor='grey'></td>
    <td id='boardCell'></td>
    <td bgcolor='grey'></td>
    <td id = 'p2StackCell'></td>
  </tr>
</table>

<br>
<button type = "button" id = "playAgainButton" onclick = "resetGame()" style="margin: 0 auto">click to play again</button>


  <script>
    document.getElementById('playAgainButton').style.display = 'none'
    // --------------------- variables ------------------------------

    var imageArr = []
    imageArr[0] = 'images/white';
    imageArr[1] = 'images/blue1.png';
    imageArr[2] = 'images/blue2.png';
    imageArr[3] = 'images/blue3.png';
    imageArr[4] = 'images/blue4.png';
    imageArr[-1] = 'images/red1.png';
    imageArr[-2] = 'images/red2.png';
    imageArr[-3] = 'images/red3.png';
    imageArr[-4] = 'images/red4.png';

    var p = document.getElementById('text');
    
    var blue = 0x0000FF;
    var red = 0xFF0000;
    //var bluePiece = 

    var fixedMoves = [
      [-1, 2, 0, 0],
      [-1, 2, 3, 3],
      [-1, 2, 3, 3],
      [-1, 2, 2, 3],
      [-1, 2, 3, 3],
      [2, 3, 2, 2],
      [-1, 2, 0, 1],
      [2, 2, 0, 2],
      [-1, 2, 1, 0],
      [1, 0, 2, 0]
    ]

    var player1 = {
      value: 1,
      color: blue,
      stack: createStack(1),
      name: ''
    }
    var player2 = {
      value: -1,
      color: red,
      stack: createStack(-1),
      name: ''
    }

    players = [player1, player2];
    var board = createBoard();
    var moveNum = 0;
    var currentPlayer = 0;
    var waitMode = 0;
    var piece = 0;
    var sx = 0;

    
    document.getElementById('boardCell').appendChild(createBoardTable());
    document.getElementById('p1StackCell').appendChild(createStackTable(0));
    document.getElementById('p2StackCell').appendChild(createStackTable(1));
    updateTable(board, players[0].stack, players[1].stack);

    //printBoard(board, players[0].stack, players[1].stack);


    // --------------------- functions --------------------------
    function createBoardTable(){
      //creates a table element that displays the board
      var tbl = document.createElement('table');

      for (i = 0; i < 4; i++){
        var tr = tbl.insertRow();

        for (j = 0; j < 4; j++){
          var td = tr.insertCell();
          td.style.border = '1px solid black';
          td.style.width = '100px';
          td.style.height = '100px';
          td.style.textAlign = 'center';
          td.style.backgroundImage = "URL(" + imageArr[0] + ")";
          td.style.backgroundRepeat = 'no-repeat';
          td.style.backgroundPosition = 'center center';
          td.id = 'board'+ i + j;
          moveStr = '(' + j + ',' + i + ')';
          td.setAttribute('onclick', 'makeMove' + moveStr);
        }
      }
      return tbl;
    }

    function createStackTable(playerId){
      //creates a table element that displays a stack
      var tbl = document.createElement('table');

      for (i = 0; i < 3; i++){
        var tr = tbl.insertRow();
        var td = tr.insertCell();
        //td.style.border = '1px solid black';
        td.style.width = '100px';
        td.style.height = '100px';
        td.style.textAlign = 'center';
        td.style.backgroundPosition = 'center center';
        td.style.backgroundRepeat = 'no-repeat';
        if (playerId == 0){
          td.id = 'p1'+ i;
          moveStr = '(-1,' + i + ')';
          td.setAttribute('onclick', 'makeMove' + moveStr);
        }
        else {
          td.id = 'p2' + i;
          moveStr = '(-2,' + i + ')';
          td.setAttribute('onclick', 'makeMove' + moveStr);
        }
      }
      return tbl;
    }


    function resetGame(){
      board = createBoard();
      player1.stack = createStack(1);
      player2.stack = createStack(-1);
      updateTable(board, players[0].stack, players[1].stack);
      document.getElementById('playAgainButton').style.display = 'none';
    }


    function createBoard(){
      //creates an empty 4x4 array that represents the board
      var board = new Array(4);
      for (var i = 0; i < board.length; i++) {
        board[i] = [[0],[0],[0],[0]];
      }
      return board
    }

    function createStack(valueIn){
      //creates a 3x1x4 array that represents a players stack of pieces
      var stack = [[],[],[]]
      for (var i = 0; i < stack.length; i++) {
        var x = new Array();
        for (var j = 0; j < 5; j++){
          x.push(valueIn*(j));
          stack[i] = x;
        }
      }
      return stack
    }

    /*
    function printBoard(boardIn, stack1In, stack2In){
      //not used rn
      for (i = 0; i < stack1In.length; i++){
        p.innerHTML += '[' + stack1In[i] + ']'
      }
      p.innerHTML += '<br>'
      
      for (i = 0; i < board.length; i++){
        for (j = 0; j < board[i].length; j++){
          p.innerHTML += '[' + board[i][j] +']'
        }
        p.innerHTML += '<br>'
      }
      
      for (i = 0; i < stack2In.length; i++){
        p.innerHTML += '[' + stack2In[i] + ']'
      } 
      p.innerHTML += '<br>'
      p.innerHTML += '---------------------------------<br>'
    }
    */

    /* not used rn
    function getSelection(moveNumIn, movesArrIn){
      return [movesArrIn[moveNumIn][0], movesArrIn[moveNumIn][1]]
    }*/


    function legalSelection(currentPlayerValueIn, pieceIn){
      //checks if the piece selected was legal
      //returns 0 if good, 1 if no piece selected, and 2 if the opponets piece is select
      if (pieceIn == 0){
        console.log('bad selection');
        p.innerHTML += "no piece, pick again" + '<br>';
        return 1
      }
      if (pieceIn * currentPlayerValueIn < 0){
        console.log('bad selection');
        p.innerHTML += "Illegal selection, pick again" + '<br>';
        return 2
      }
      console.log('good selection');
      return 0
    }

     /*not used rn
    function getTarget(moveNumIn, movesArrIn){
      return [movesArrIn[moveNumIn][2], movesArrIn[moveNumIn][3]]
    }*/

    function legalTarget(pieceIn, txIn, tyIn, boardIn){
      //checks if a piece can move to a given square
      //returns 0 if legal and 1 if illegal

      //If the piece is smaller than the piece on the target square, return an error
      if (Math.abs(pieceIn) <= Math.abs(getLargestPiece(boardIn, txIn, tyIn))){
        p.innerHTML += "piece too small" + '<br>';
        return 1
      }

      //checks if selected piece is from stack and if there is a piece on target square
      // if the piece is part of three in a row move is legal, if not return and error
      if (sx < 0 && Math.abs(getLargestPiece(boardIn, txIn, tyIn)) > 0){
        if (threeInRow(boardIn, txIn, tyIn, players[currentPlayer].value) == true){
          return 0
        }
        else{
          p.innerHTML += "can't gobble that" + "<br>";
          return 2
        }
      }
      // returns legal
      else{
        return 0
      }
    }

    function getLargestPiece(boardIn, xIn, yIn){
      return boardIn[yIn][xIn][boardIn[yIn][xIn].length - 1]
    }


    function threeInRow(boardIn, xIn, yIn, currentPlayerValueIn){
      var triosToCheckList = [];
      for (i = 0; i < 4; i++){
        if (i == 0){
          var xDir = 1, yDir = 0;}
        if (i == 1){
          var xDir = 0, yDir = 1;}
        if (i == 2){
          var xDir = -1, yDir = 1;}
        if (i == 3){
          var xDir = 1, yDir = 1;}
        
        for (j = -2; j < 1; j++){
          var xStart = xIn + j * xDir;
          var yStart = yIn + j * yDir;
          var count = 0;
          console.log("direction: " + i + ", starting square: " + xStart + yStart)
          
          for (k = 0; k < 3; k++){
            var sqX = xStart + k * xDir;
            var sqY = yStart + k * yDir;
            console.log("square: " + sqX + sqY);
            if (0 <= sqX && sqX <= 3 && 0 <= sqY && sqY<= 3){
              var largestPiece = getLargestPiece(boardIn, sqX, sqY);
              if (largestPiece * currentPlayerValueIn < 0){
                count += 1;
              }
            }
          }
          if (count == 3){
            return true;
          } 
        }
      }

    }

    function checkForWinner(boardIn){
      var lineValue = 0;
      // row
      for (i = 0; i < 4; i++){
        for (j = 0; j < 4; j++){
          largestPiece = boardIn[i][j][boardIn[i][j].length - 1]

          if (largestPiece !== 0){
            lineValue += (largestPiece)/(Math.abs(largestPiece))
          }
        }
        if (Math.abs(lineValue) == 4){
          document.getElementById("playAgainButton").style.display = "block";
        }
        lineValue = 0;
      }
    
      // column
      for (i = 0; i < 4; i++){
        for (j = 0; j < 4; j++){
          largestPiece = boardIn[j][i][boardIn[j][i].length - 1]

          if (largestPiece !== 0){
            lineValue += (largestPiece)/(Math.abs(largestPiece))
          }
        }
        if (Math.abs(lineValue) == 4){
          document.getElementById("playAgainButton").style.display = "block";
        }
        lineValue = 0;
      }

      // diagonal \
      for (i = 0; i < 4; i++){
        largestPiece = boardIn[i][i][boardIn[i][i].length - 1];

        if (largestPiece !== 0){
          lineValue += (largestPiece)/(Math.abs(largestPiece))
        }
      }
      if (Math.abs(lineValue) == 4){
        document.getElementById("playAgainButton").style.display = "block";
      }
      lineValue = 0;

      // diagonal /
      for (i = 0; i < 4; i++){
        largestPiece = boardIn[i][3-i][boardIn[i][3-i].length - 1];

        if (largestPiece !== 0){
          lineValue += (largestPiece)/(Math.abs(largestPiece))
        }
      }
      if (Math.abs(lineValue) == 4){
        document.getElementById("playAgainButton").style.display = "block";
      }
      lineValue = 0;
      
    }

    function updateTable(boardIn, stack1In, stack2In){
      //updates the cells in the table displayed on the website page with images of pieces
      //board
      for(i = 0; i < boardIn.length; i++){
        for(j = 0; j < boardIn[i].length; j++){
          var square = document.getElementById('board' + i + j);
          /*if (boardIn[i][j].length == 0){
            square.style.backgroundImage = "URL(" + imageArr[0] + ")";
            square.innerHTML = 0;
          }
          else {*/
          var visiblePiece = boardIn[i][j][board[i][j].length -1]
          square.style.backgroundImage = "URL(" + imageArr[visiblePiece] + ")";
          square.innerHTML = visiblePiece;
          //}
        }
      }
      //stack1
      for (i = 0; i < stack1In.length; i++){
        var square = document.getElementById('p1' + i);
        if (stack1In[i].length == 0){
            square.style.backgroundImage = "URL(" + imageArr[0] + ")";
            square.innerHTML = 0;
        }
        else {
          var visiblePiece = stack1In[i][stack1In[i].length -1];
          square.innerHTML = visiblePiece;
          square.style.backgroundImage = "URL(" + imageArr[visiblePiece] + ")";
        }
      }
      //stack2
      for (i = 0; i < stack2In.length; i++){
        square = document.getElementById('p2' + i)
        if (stack2In[i].length == 0){
            square.innerHTML = 0
            square.style.backgroundImage = "URL(" + imageArr[0] + ")";
        }
        else {
          var visiblePiece = stack2In[i][stack2In[i].length -1];
          square.innerHTML = visiblePiece;
          square.style.backgroundImage = "URL(" + imageArr[visiblePiece] + ")";
        }
      }
      
    }

    
    function makeMove(xIn, yIn){
      //function called when a cell in the table is clicked on
      console.log('move number: '+ moveNum);
      console.log('current player: ' + currentPlayer);
      p.innerHTML = ''
      //p.innerHTML = 'move number: ' + moveNum + '<br>';
      //p.innerHTML += 'current player: ' + currentPlayer + '<br>';

      // waitmode is 0 when player needs to select a piece
      if (waitMode == 0){
        sx = xIn
        var sy = yIn;
        if (sx < 0){
          piece = players[Math.abs(sx)-1].stack[sy].pop();
        }
        else{
          piece = board[sy][sx].pop();
        }

        console.log(sx, sy, piece);
        //p.innerHTML += 'selection: ' + sx + sy + piece + '<br>'
        var legalSelect = legalSelection(players[currentPlayer].value, piece);

        if (legalSelect == 1){
          console.log('error 1');
          board[sy][sx].push(piece);
          return 
        }
        if (legalSelect == 2){
          console.log('error 2');
          if (sx < 0){
            players[Math.abs(sx)-1].stack[sy].push(piece);
            return 
          }
          else{
            board[sy][sx].push(piece);
            return 
          }
        }
      }

      //waitemode is 1 when a player has selected a piece and needs to move it
      if (waitMode == 1){
        var tx = xIn, ty = yIn
        console.log(tx, ty, piece)
        //p.innerHTML += 'target: ' + tx + ty + '<br>'

        legalTarg = legalTarget(piece, tx, ty, board);
        if (legalTarg == 0){
          board[ty][tx].push(piece);
        }
        else {
          console.log('bad target')
          return 1
        }
    
        checkForWinner(board);
        currentPlayer = Math.abs(currentPlayer - 1);
        moveNum ++;
      }

      waitMode = Math.abs(waitMode -1)

      console.log(players[0].stack);
      console.log(board);
      console.log(players[1].stack);
      console.log('----------------------------------')
      //printBoard(board, players[0].stack, players[1].stack);
      updateTable(board, players[0].stack, players[1].stack);
    
    }

    /*
    // ----------------------- setup Pixi ----------------------
    //Create a Pixi Application and add canvas as an HTML element
    let app = new PIXI.Application({width: 700, height: 400, backgroundColor: 0x888888});
    app.stage.interactive = true;
    document.body.appendChild(app.view);
    
    boardSize = Math.min(0.95*app.screen.height, app.screen.width*2/3)
    squareSize = boardSize / 4;
    console.log(boardSize, squareSize)

    pixiBoard = new PIXI.Container();
    pixiBoard.x = app.screen.width / 2;
    pixiBoard.y = app.screen.height / 2;

    player1stack = new PIXI.Container();
    player1stack.x = (app.screen.width - boardSize)/4
    player1stack.y = app.screen.height / 2;

    player2stack = new PIXI.Container();
    player2stack.x = screen.width - (app.screen.width - boardSize)/4
    player2stack.y = app.screen.height / 2;
    app.stage.addChild(pixiBoard, player1stack, player2stack);

    // ---------------------- main game loop -------------------------
    var board = createBoard();
  
    // creates the 4x4 board inside the board Container
    boardTexture = PIXI.Texture.from('4x4 board.png')
    boardImg = new PIXI.Sprite(boardTexture);
    boardImg.height = boardSize;
    boardImg.width = boardSize;
    boardImg.anchor.set(0.5,0.5);
    pixiBoard.addChild(boardImg);

    console.log((app.screen.width - boardSize)/2)
    // creates stack of pieces
    for (var i = 0; i < 4; i++) {
      for (var j = 0; j < 3; j++) {
        for (var k = 0; k < 1; k++) {
          piece = new Piece(blue, i+1, PLAYER_1);
          piece.createSprite();
          piece.sprite.x = 0
          piece.sprite.y = (j-1)*squareSize;
          player1stack.addChild(piece.sprite);
        }
      }
    }

    var clicks = 0;
    function clicked(){
      clicks += 1;
      console.log(clicks);
    }
    

    app.stage.on('pointerdown', clicked);
    */
    

  </script>
</body>
</html>
